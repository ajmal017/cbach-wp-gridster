(function(){tinymce.create("tinymce.plugins.gridster_shortcode",{init:function(a,b){var c=this;c.url=b,c._createButtons(),a.onBeforeSetContent.add(function(a,b){b.content=c._do_gridster_shortcode(b.content)}),a.onExecCommand.add(function(a,b){"mceInsertContent"===b&&tinyMCE.activeEditor.setContent(c._do_gridster_shortcode(tinyMCE.activeEditor.getContent()))}),a.onPostProcess.add(function(a,b){b.get&&(b.content=c._get_gridster_shortcode(b.content))}),a.addCommand("ajax_gridster_shortcode_update_modal",function(c,d){a.windowManager.open({file:ajaxurl+"?action=ajax_gridster_shortcode_update_modal&nonce="+a.getLang("gridster_shortcode.AjaxNonce")+"&selected="+d,width:300,height:240,title:a.getLang("gridster_shortcode.popupTitle"),inline:1},{plugin_url:b})}),a.addCommand("gridster_edit_current_gridster",function(){var a=tinymce.activeEditor,b=a.selection.getNode();if("IMG"==b.nodeName&&a.dom.hasClass(b,"gridsterShortcodeGUI")){var c=a.plugins.gridster_shortcode._get_gridster_id(b),d=ajaxurl.split("admin-ajax.php"),e=d[0],f="post.php?post="+c+"&action=edit";window.top.location.href=e+f}}),a.addButton("gridster_shortcode",{title:a.getLang("gridster_shortcode.buttonTitle"),cmd:"ajax_gridster_shortcode_update_modal"}),a.onMouseDown.add(function(a,b){"IMG"==b.target.nodeName&&a.dom.hasClass(b.target,"gridsterShortcodeGUI")&&(a.plugins.gridster_shortcode._hideButtons(),a.plugins.wordpress._showButtons(b.target,"gridster_sr_btns"))}),a.onInit.add(function(a){tinymce.dom.Event.add(a.getWin(),"scroll",function(){a.plugins.gridster_shortcode._hideButtons()}),tinymce.dom.Event.add(a.getBody(),"dragstart",function(){a.plugins.gridster_shortcode._hideButtons()})}),a.onBeforeExecCommand.add(function(a){a.plugins.gridster_shortcode._hideButtons()}),a.onSaveContent.add(function(a){a.plugins.gridster_shortcode._hideButtons()}),a.onMouseDown.add(function(a,b){"IMG"!=b.target.nodeName&&a.plugins.gridster_shortcode._hideButtons()}),a.onKeyDown.add(function(a,b){(b.which==tinymce.VK.DELETE||b.which==tinymce.VK.BACKSPACE)&&a.plugins.gridster_shortcode._hideButtons()})},_do_gridster_shortcode:function(a){var b=this;return a.replace(/\[gridster([^\]]*)\]/g,function(a,c){return'<img src="'+b.url+'/img/t.gif" class="gridsterShortcodeGUI mceItem" title="gridster'+tinymce.DOM.encode(c)+'" />'})},_get_gridster_shortcode:function(a){function b(a,b){return b=RegExp(b+'="([^"]+)"',"g").exec(a),b?tinymce.DOM.decode(b[1]):""}return a.replace(/(?:<p[^>]*>)*(<img[^>]+>)(?:<\/p>)*/g,function(a,c){var d=b(c,"class");return-1!=d.indexOf("gridsterShortcodeGUI")?"<p>["+tinymce.trim(b(c,"title"))+"]</p>":a})},_get_gridster_id:function(a){function b(a,b){return b=RegExp(b+"=&quot;([0-9]+)&quot;").exec(a),b?tinymce.DOM.decode(b[1]):""}var c=a.cloneNode(!0),d=document.createElement("div");d.appendChild(c);var e=d.innerHTML,f=b(e,"id");return f},_createButtons:function(){var d,e,f,a=this,b=tinymce.activeEditor,c=tinymce.DOM;c.get("gridster_sr_btns")||(f=window.devicePixelRatio&&window.devicePixelRatio>1||window.matchMedia&&window.matchMedia("(min-resolution:130dpi)").matches,c.add(document.body,"div",{id:"gridster_sr_btns",style:"display:none;"}),changeButton=c.add("gridster_sr_btns","img",{src:f?a.url+"/img/change-2x.png":a.url+"/img/change.png",id:"gridster_changeShortcode",width:"24",height:"24",title:b.getLang("gridster_shortcode.changeButton")}),tinymce.dom.Event.add(changeButton,"mousedown",function(){var b=tinymce.activeEditor,c=b.selection.getNode();if("IMG"==c.nodeName&&b.dom.hasClass(c,"gridsterShortcodeGUI")){var d=b.plugins.gridster_shortcode._get_gridster_id(c);b.execCommand("ajax_gridster_shortcode_update_modal",!1,d),b.plugins.gridster_shortcode._hideButtons()}}),d=c.add("gridster_sr_btns","img",{src:f?a.url+"/img/edit-2x.png":a.url+"/img/edit.png",id:"gridster_editShortcode",width:"24",height:"24",title:b.getLang("gridster_shortcode.editButton")}),tinymce.dom.Event.add(d,"mousedown",function(){var b=tinymce.activeEditor;b.execCommand("gridster_edit_current_gridster"),b.plugins.gridster_shortcode._hideButtons()}),e=c.add("gridster_sr_btns","img",{src:f?a.url+"/img/delete-2x.png":a.url+"/img/delete.png",id:"gridster_delShortcode",width:"24",height:"24",title:b.getLang("gridster_shortcode.dellButton")}),tinymce.dom.Event.add(e,"mousedown",function(a){var b=tinymce.activeEditor,c=b.selection.getNode();"IMG"==c.nodeName&&b.dom.hasClass(c,"gridsterShortcodeGUI")&&(b.dom.remove(c),b.execCommand("mceRepaint"),b.dom.events.cancel(a)),b.plugins.gridster_shortcode._hideButtons()}))},_hideButtons:function(){var a=tinymce.DOM;a.hide(a.select("#gridster_sr_btns"))},getInfo:function(){return{longname:"Gridster shortcode replace with user-friendly GUI",author:"Carsten Bach",authorurl:"http://carsten-bach.de",infourl:"https://github.com/carstingaxion/cbach-wp-gridster",version:"1.0"}}}),tinymce.PluginManager.add("gridster_shortcode",tinymce.plugins.gridster_shortcode)})();